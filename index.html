<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Parkrun stopwatch comparison/merging</title>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="parkrun-stopwatch-container" class="main-content container">
  <div id="parkrun-stopwatch"></div>
</div>

<script src="parkrun-stopwatch.js"></script>
<script src="jquery-3.3.1.js"></script>
<script>
var app = Elm.ParkrunStopwatch.init({node: document.getElementById("parkrun-stopwatch")});
app.ports.getInitialHeight.subscribe(function () {
    handleResize();
})

var currentResizeTimeout = null;

var RESIZE_DELAY_MS = 100;

function handleResize() {
    var body = $("body");
    var vertMargin = body.outerHeight(true) - body.height();
    var containerHeight = $(window).height() - vertMargin;
    var headerHeight = $("#header").outerHeight(true);

    body.height(containerHeight);
    app.ports.heightUpdated.send(Math.floor(containerHeight - headerHeight));
    currentResizeTimeout = null;
}

function handleWindowResize() {
    if (currentResizeTimeout !== null) {
        clearTimeout(this.currentResizeTimeout);
    }

    this.currentResizeTimeout = setTimeout(function() { handleResize(); }, RESIZE_DELAY_MS);
};

$(window).resize(handleWindowResize);

function handleSingleFileLoad(file) {
  var reader = new FileReader();
  reader.onload = function (e) {
    app.ports.fileDrop.send({fileName: file.name, fileText: e.target.result});
  };

  reader.readAsText(file, "UTF-8");
}

function handleLoad(files) {
  if (typeof files === "undefined") {
    // Sorry, IE9 users, can't help you here.
    alert("Sorry, this feature doesn't work in your browser.  Please try another browser.");
    return;
  }

  for (var index = 0; index < files.length; index += 1) {
    handleSingleFileLoad(files[index]);
  }
}

// Taken from https://stackoverflow.com/a/33542499
function saveFile(filename, data) {
    var blob = new Blob([data], {type: 'text/csv'});
    if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, filename);
    }
    else {
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = filename;
        document.body.appendChild(elem);
        elem.click();
        document.body.removeChild(elem);
        window.URL.revokeObjectURL(elem.href);
    }
}

// The following functions have been adapted from
// https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Selecting_files_using_drag_and_drop
function stopDefaultBehaviour(e) {
  e.stopPropagation();
  e.preventDefault();
}

function drop(e) {
  stopDefaultBehaviour(e);
  handleLoad(e.dataTransfer.files);
}

var dropzone = document.getElementById("parkrun-stopwatch-container");
dropzone.addEventListener("dragenter", stopDefaultBehaviour, false);
dropzone.addEventListener("dragover", stopDefaultBehaviour, false);
dropzone.addEventListener("drop", drop, false);

</script>

</body>
</html>
