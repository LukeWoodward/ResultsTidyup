<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Parkrun results tidyup</title>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="parkrun-results-container" class="main-content container">
  <div id="parkrun-results"></div>
</div>

<script src="parkrun-results.js"></script>
<script src="jquery-3.3.1.js"></script>
<script>
var startTime = parseInt(window.localStorage.getItem("eventStartTime"), 10);
if (isNaN(startTime)) {
    startTime = null;
}

var app = Elm.ParkrunResults.init({
    node: document.getElementById("parkrun-results"),
    flags: startTime
});

app.ports.getInitialHeight.subscribe(function () {
    handleResize();
});

app.ports.recordEventStartTime.subscribe(function (time) {
    window.localStorage.setItem("eventStartTime", time);
});

var currentResizeTimeout = null;

var RESIZE_DELAY_MS = 100;

function handleResize() {
    var body = $("body");
    var vertMargin = body.outerHeight(true) - body.height();
    var containerHeight = $(window).height() - vertMargin;
    var headerHeight = $("#header").outerHeight(true);

    body.height(containerHeight);
    app.ports.heightUpdated.send(Math.floor(containerHeight - headerHeight));
    currentResizeTimeout = null;
}

function handleWindowResize() {
    if (currentResizeTimeout !== null) {
        clearTimeout(this.currentResizeTimeout);
    }

    this.currentResizeTimeout = setTimeout(function() { handleResize(); }, RESIZE_DELAY_MS);
};

$(window).resize(handleWindowResize);

var allFilesDropped = [];

function handleNextFileLoad(files, index) {
  var reader = new FileReader();
  reader.onload = function (e) {
    allFilesDropped.push({
      fileName: files[index].name,
      // Replace UTF-8 byte-order marks for the benefit of IE.
      fileText: e.target.result.replace(/\ufeff/, "")
    });

    if (allFilesDropped.length < files.length) {
      handleNextFileLoad(files, index + 1);
    }
    else {
      app.ports.filesDropped.send(allFilesDropped);
      allFilesDropped = [];
    }
  };

  if (index < files.length) {
    reader.readAsText(files[index], "UTF-8");
  }
}

function handleLoad(files) {
  if (typeof files === "undefined") {
    // Sorry, IE9 users, can't help you here.
    alert("Sorry, this feature doesn't work in your browser.  Please try another browser.");
    return;
  }

  allFilesDropped = [];
  handleNextFileLoad(files, 0);
}

// The following functions have been adapted from
// https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Selecting_files_using_drag_and_drop
function stopDefaultBehaviour(e) {
  e.stopPropagation();
  e.preventDefault();
}

function drop(e) {
  stopDefaultBehaviour(e);
  handleLoad(e.dataTransfer.files);
}

var dropzone = document.getElementById("parkrun-results-container");
dropzone.addEventListener("dragenter", stopDefaultBehaviour, false);
dropzone.addEventListener("dragover", stopDefaultBehaviour, false);
dropzone.addEventListener("drop", drop, false);

</script>

</body>
</html>
